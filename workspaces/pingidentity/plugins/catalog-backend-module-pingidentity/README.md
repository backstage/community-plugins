# Ping Identity Backend Plugin for Backstage
The Ping Identity backend plugin integrates Ping Identity into Backstage.

# Capabilities
The Ping Identity backend plugin has the following capabilities:

### User and group ingestion
* Synchronization of Ping Identity users in an environment
* Synchronization of Ping Identity groups and their users in the environment

### Default User Transformer
By default, any illegal characters in an entity reference in Backstage will be normalized to `_` by the default user transformer. Backstage can only accept sequences composed of `[a-z0-9A-Z]`, possibly separated by one of `[-_.]`.

The user and group transformers can be customized by leveraging the `pingIdentityTransformerExtensionPoint`. More details on this extension point can be found in the configuration section.

# Getting Started
The plugin can be seen in action in the example Backstage app included in this workspace. Run `yarn dev` in the `workspaces/pingidentity` directory to start the app. Navigate to the `Home` tab, and the ingested users and groups will appear under the `User` and `Group` kind entities in the catalog.

The plugin can also be run independently with `yarn start` in the `workspaces/pingidentity/plugins/catalog-backend-module-pingidentity` directory. 

# Configuration

## New backend configuration

    1. Add the following configuration to the app-config.yaml file, and customize the schedule to fit your needs:

    ```yaml title="app-config.yaml"
    catalog:
    providers:
        pingIdentityOrg:
        default:
            apiPath: https://api.pingone.ca/v1 # Change domain according to ping identity regional domain
            authPath: https://auth.pingone.ca 
            envId: ${PING_IDENTITY_ENV_ID}
            clientId: ${PING_IDENTITY_CLIENT_ID}
            clientSecret: ${PING_IDENTITY_CLIENT_SECRET}
            schedule: # Mandatory; same options as in TaskScheduleDefinition
            # supports cron, ISO duration, "human duration" as used in code
            frequency: { minutes: 30 } # Customize this to fit your needs
            # supports ISO duration, "human duration" as used in code
            timeout: { minutes: 10 } # Customize this to fit your needs
            initialDelay: { seconds: 15 } # Customize this to fit your needs
    ```

2. Register the plugin in the `packages/backend/src/index.ts` file:

   ```ts title="packages/backend/src/index.ts"
   const backend = createBackend();

   /* highlight-add-next-line */
   backend.add(import('@backstage-community/plugin-catalog-backend-module-pingidentity'));

   backend.start();
   ```

3. Optional: To configure custom transformer function for user/group to mutate the entity generated by the Ping Identity plugin. Create a new backend module with the `yarn new` command and add your custom user and group transformers to the `pingIdentityTransformerExtensionPoint`. Then install this new backend module into your backstage backend. Below is an example of how the backend module can be defined:

   ```ts title="plugins/<module-name>/src/module.ts"
   /* highlight-add-start */
   import {
     pingIdentityTransformerExtensionPoint,
     GroupTransformer,
     UserTransformer,
   } from '@backstage-community/plugin-catalog-backend-module-pingidentity';

   const customGroupTransformer: GroupTransformer = async (
     entity,
     envId,
   ) => {
     /* apply transformations */
     return entity;
   };
   const customUserTransformer: UserTransformer = async (
     entity,
     envId,
     groups,
   ) => {
     /* apply transformations */
     return entity;
   };
   /* highlight-add-end */

   export const pingIdentityBackendModuleTransformer = createBackendModule({
     pluginId: 'catalog',
     moduleId: 'pingIdentity-transformer',
     register(reg) {
       reg.registerInit({
         deps: {
           /* highlight-add-start */
           pingIdentity: pingIdentityTransformerExtensionPoint,
           /* highlight-add-end */
         },
         /* highlight-add-start */
         async init({ pingIdentity }) {
           pingIdentity.setUserTransformer(customUserTransformer);
           pingIdentity.setGroupTransformer(customGroupTransformer);
           /* highlight-add-end */
         },
       });
     },
   });
   ```

   ***

   **IMPORTANT**

   The `pluginId` for the module **MUST** be set to `catalog` to match the `pluginId` of the Ping Identity plugin or else the module will fail to initialize.

   ***
